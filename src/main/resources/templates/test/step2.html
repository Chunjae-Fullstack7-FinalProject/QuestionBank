<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>T셀파 문제은행</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="../../inc/css/font.css">
	<link rel="stylesheet" href="../../inc/css/reset.css">
	<link rel="stylesheet" href="../../inc/css/common.css">

	<script src="https://code.jquery.com/jquery-1.12.4.min.js"
			integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
	<script src="../../inc/js/common.js"></script>
</head>
<body>
	<div id="wrap" class="full-pop-que">
		<div class="full-pop-wrap">
			<div class="pop-header">
				<ul class="title">
					<li>STEP 1 단원선택</li>
					<li class="active">STEP 2 문항 편집</li>
					<li>STEP 3 시험지 저장</li>
				</ul>
				<button type="button" class="del-btn"></button>
			</div>
			<div class="pop-content">
				<div class="view-box">
					<div class="view-top">
						<div class="paper-info">
							<span>수학 1</span>
							이준열(2015)
						</div>
						<button class="btn-default btn-research"><i class="research"></i>재검색</button>
						<button class="btn-default pop-btn" data-pop="que-scope-pop">출제범위</button>
					</div>
					<div class="view-bottom type01">
						<div class="cnt-box">
							<div class="cnt-top">
								<span class="title">문제 목록</span>
								<div class="right-area">
									<div class="select-wrap">
										<button type="button" class="select-btn">문제만 보기</button>
										<ul class="select-list" style="display: none;">
											<li>
												<a href="javascript:;">문제만 보기</a>
											</li>
											<li>
												<a href="javascript:;">문제+정답 보기</a>
											</li>
											<li>
												<a href="javascript:;">문제+해설+정답 보기</a>
											</li>
											<li class="disabled">
												<a href="javascript:;">편집단계에서만 적용되는 보기 옵션</a>
											</li>
										</ul>
									</div>
									<div class="select-wrap">
										<button type="button" class="select-btn">단원순</button>
										<ul class="select-list">
											<li>
												<a href="javascript:;">사용자 정렬</a>
											</li>
											<li>
												<a href="javascript:;">단원순</a>
											</li>
											<li>
												<a href="javascript:;">난이도순</a>
											</li>
											<li>
												<a href="javascript:;">문제 형태순</a>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<div class="view-que-list scroll-inner" style="display: -webkit-box;-webkit-box-orient:vertical">

							</div>
							<div class="bottom-box">
								<div class="que-badge-group type01">
									<div class="que-badge-wrap">
										<span class="que-badge purple">하</span>
										<span class="num">5</span>
									</div>
									<div class="que-badge-wrap">
										<span class="que-badge green">중</span>
										<span class="num">15</span>
									</div>
									<div class="que-badge-wrap">
										<span class="que-badge yellow">상</span>
										<span class="num">25</span>
									</div>
								</div>
								<p class="total-num">총 <span>30</span>문제</p>
							</div>
						</div>
						<div class="cnt-box type01">
							<div class="tab-wrap">
								<ul class="tab-menu-type01">
									<li class="ui-tab-btn active">
										<a href="javascript:;">문제지 요약</a>
									</li>
									<li class="ui-tab-btn">
										<a href="javascript:;">유사 문제</a>
									</li>
									<li class="ui-tab-btn">
										<a href="javascript:;">삭제 문항</a>
									</li>
								</ul>
								<div class="contents on">
									<div class="table half-type no-passage">
										<!--지문 없는 테이블 유형-->
										<div class="fix-head">
											<span>이동</span>
											<span>번호</span>
											<span>시험지명</span>
											<!--문제 유형-->
											<span>문제 형태</span>
											<span>난이도</span>
										</div>
									</div>
									<div class="bottom-box">
										<div class="que-badge-group">
											<div class="que-badge-wrap">
												<span class="que-badge gray">객관식</span>
												<span class="num">35</span>
											</div>
											<div class="que-badge-wrap">
												<span class="que-badge gray">주관식</span>
												<span class="num">15</span>
											</div>
										</div>
									</div>
								</div>
								<div class="contents">
									탭 컨텐츠 (2)
								</div>
								<div class="contents">
									탭 컨텐츠 (3)
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="step-btn-wrap">
				<button type="button" class="btn-step">STEP 1 단원 선택</button>
				<button type="button" class="btn-step next">STEP 3 시험지 저장 </button>
			</div>
		</div>
		<div class="dim"></div>

		<!-- 문항 오류 신고 팝업 -->
		<div class="pop-wrap table-type" data-pop="error-report-pop">
			<div class="pop-inner">
				<div class="pop-header">
					<span>문항 오류 신고</span>
					<button type="button" class="pop-close"></button>
				</div>
				<div class="pop-content">
					<table>
						<colgroup>
							<col width="30%">
							<col width="*">
						</colgroup>
						<tbody>
							<tr>
								<th>오류유형</th>
								<td>
									<div class="select-wrap">
										<button type="button" class="select-btn">문제오류</button>
										<ul class="select-list">
											<li>
												<a href="javascript:;">문제오류</a>
											</li>
											<li>
												<a href="javascript:;">정답오류</a>
											</li>
											<li>
												<a href="javascript:;">풀이오류</a>
											</li>
											<li>
												<a href="javascript:;">이미지오류</a>
											</li>
											<li>
												<a href="javascript:;">유형오류</a>
											</li>
											<li>
												<a href="javascript:;">기타</a>
											</li>
										</ul>
									</div>
								</td>
							</tr>
							<tr>
								<th>첨부파일</th>
								<td class="file">
									<input type="text" placeholder="최대 100MB까지 등록가능">
									<button type="button" class="btn-icon">파일 첨부</button>
								</td>
							</tr>
							<tr>
								<th>오류 내용</th>
								<td>
									<textarea name="" id="" cols="30" rows="4" placeholder="오류내용을 간단히 적어주세요. (최대 50자)"></textarea>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="pop-footer">
					<button type="button">신고하기</button>
				</div>
			</div>
		</div>
		<!-- 출제범위 팝업 -->
		<div class="pop-wrap scope-type" data-pop="que-scope-pop">
			<div class="pop-inner">
				<div class="pop-header">
					<span>국어 1-1</span>
					<button type="button" class="pop-close"></button>
				</div>
				<div class="pop-content scroll-inner">
					<div class="scope-wrap">
						<!-- 출제 범위 내용-->
						<ul>1. 새로운 시작
							<li>(1)시의 아름다움
								<span>[1] 포근한 봄</span>
								<span>[2] 포근한 봄</span>
							</li>
							<li>(2)산문의 향기
								<span>[1] 꿩</span>
							</li>
						</ul>
						<ul>2. 세상과 함께 자라는 꿈
							<li>(1) 자료 찾으며 책 읽기
								<span>[1] 버터 플라이</span>
							</li>
							<li>(2) 통일성 있게 글 쓰기</li>
						</ul>
						<ul>3. 언어랑 국어랑 놀자
							<li>(1) 언어의 본질과 국어 생활</li>
							<li>(2) 우리말의 아홉 품사</li>
						</ul>
						<ul>4. 더불어 살아가기
							<li>(1) 문학과 갈등</li>
							<li>(2) 토의하기</li>
						</ul>
						<ul>1. 새로운 시작
							<li>(1)시의 아름다움</li>
							<li>(2)산문의 향기</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
			//문항id 배열로 티셀파 문항 리스트 조회(img) 요청
			const questionIds = [[${questionIds}]];
			const API_BASE_URL = '/bridge/t-sherpa'; // 프록시 서버 경로
			let questions = [];
			async function getQuestionInfo() {
				try {
					const response = await fetch(`${API_BASE_URL}/item-img/item-list`, {
						method: "POST",
						headers: {
							"Content-Type": "application/json"
						},
						body: JSON.stringify({
							itemIdList: questionIds
						})
					});
					const data = await response.json();
					if (data.successYn === 'Y') {
						questions = data.itemList;
						console.log("성공:", questions);
						sortByPassageId(questions);
					} else {
						console.error("실패:", data);
					}
				} catch (error) {
					console.error("fetch 오류:", error);
				}
			}
			//검색 조건 버튼 이벤트
			function searchQuestions(status){
				console.log(status);
				let searchList = [];
				switch(status){
					case "문제만 보기":
						searchList = questions.map(q => ({
							...q,
							explainUrl: null,
							answerUrl: null,
						}))
						break;
					case "문제+정답 보기":
						searchList = questions.map(q => ({
							...q, // 전체 데이터를 복사
							explainUrl: null
						}));
						break;
					case "문제+해설+정답 보기":
						searchList = questions
						break;
					case "편집단계에서만 적용되는 보기 옵션":
						break;
					default: //문제만 보기
						searchList = questions.map(q => ({
							...q,
							explainUrl: null,
							answerUrl: null,
						}))
						break;
				}
				renderQuestions(searchList);
			}

			//검색 이벤트 리스너
			document.querySelectorAll(".select-wrap .select-list a").forEach(button =>{
				button.addEventListener("click", (e) =>{
					const status = e.target.textContent.trim();
					if(["문제만 보기", "문제+정답 보기", "문제+해설+정답 보기", "편집단계에서만 적용되는 보기 옵션"].includes(status)){
						searchQuestions(status);
					}
				})
			})

			//정렬 조건 버튼 이벤트
			function sortQuestions(status){
				//기존 데이터를 사용해야함
				let sortQuestionsList = [...questions];
				console.log(sortQuestionsList);
				switch (status){
					case "단원순":
						sortQuestionsList.sort((a, b) => (a.largeChapterName || "").localeCompare(b.largeChapterName || ""));
						break;
					case "난이도순":
						const level = { "최하": 1, "하": 2, "중": 3, "상": 4, "최상": 5 };

						//지문별로 그룹화 (단일 문항 포함)
						const groupedByPassage = questions.reduce((groups, question) => {
							const passageId = question.passageId || `null`;
							if (!groups[passageId]) {
								groups[passageId] = [];
							}
							groups[passageId].push(question);
							return groups;
						}, {});

						//그룹 정보 계산 (지문별 데이터 생성)
						const groupedArray = Object.entries(groupedByPassage).map(([passageId, questions]) => {
							const minDifficulty = Math.min(
									...questions.map(q => level[q.difficultyName] || Infinity)
							);
							const chapterName = questions[0].largeChapterName || "기타";
							const singleQuestion = passageId.startsWith("null");
							return { passageId, questions, minDifficulty, chapterName, singleQuestion };
						});

						//그룹 정렬 (난이도와 단원 순서)
						groupedArray.sort((a, b) => {
							//난이도 순으로 정렬
							if (a.minDifficulty !== b.minDifficulty) {
								return a.minDifficulty - b.minDifficulty;
							}
							//단일 문항을 앞에 두기
							if (a.singleQuestion !== b.singleQuestion) {
								return a.singleQuestion ? -1 : 1;
							}
							//단원 순서로 정렬
							return (a.chapterName || "").localeCompare(b.chapterName || "");
						});

						//그룹 내 문항 정렬 (난이도 순)
						groupedArray.forEach(group => {
							group.questions.sort((a, b) => {
								const difficultyA = level[a.difficultyName] || Infinity;
								const difficultyB = level[b.difficultyName] || Infinity;
								return difficultyA - difficultyB;
							});
						});

						//정렬된 그룹의 문항 배열로 다시 만듦
						sortQuestionsList = groupedArray.flatMap(group => group.questions);
						break
					case "문제 형태순":
						break;
					default: //단원순
						sortQuestionsList.sort((a, b) => (a.largeChapterName || "").localeCompare(b.largeChapterName || ""));
						break;
				}
				renderQuestions(sortQuestionsList);
			}

			//정렬 이벤트 리스너
			document.querySelectorAll(".select-wrap .select-list a").forEach(button =>{
				button.addEventListener("click", (e) => {
					const status = e.target.textContent.trim();
					if (["단원순", "난이도순", "문제 형태순"].includes(status)) {
						sortQuestions(status);
					}
				})
			})

			//지문 정렬(그룹 -> 정렬)
			function sortByPassageId(questions){
				//console.log(questions);
				//그룹화
				const groupList = questions.reduce((groups, question) =>{
					const passageId = question.passageId || "null";
					if(!groups[passageId]){
						groups[passageId] = [];
					}
					groups[passageId].push(question);
					return groups;
				}, {});
				//passageId가 null인 경우 가장 마지막
				const sortedPassageIds = Object.keys(groupList).sort((a, b) => {
					if (a === "null"){
						return 1;
					}
					if(b === "null"){
						return -1;
					}
					return parseInt(a) - parseInt(b); // 숫자 기준으로 정렬

				});

				//정렬된 순서대로 데이터를 배열로 재구성
				const sortedQuestions = [];
				sortedPassageIds.forEach(passageId => {
					sortedQuestions.push(...groupList[passageId]);
				})
				renderQuestions(sortedQuestions);
			}

			//문제 데이터를 화면에 렌더링
			function renderQuestions(questions) {
				//console.log(questions);
				const container = document.querySelector(".view-que-list");
				container.innerHTML = "";
				let renderedPassageIds = new Set();
				questions.forEach((q, index) => {
					let questionHTML ='';
					<!-- 앞 passgeId값과 다를 경우 -->
					const prevPassageId = index > 0 ? questions[index-1].passageId : null;
					//console.log("현재" + q.passageId);
					//console.log("이전" + prevPassageId);
					if(q.passageId !== null && q.passageId !== prevPassageId) {
						// 이전에 나온 passageId는 건너뛰기
						if (q.passageId && renderedPassageIds.has(q.passageId)) {
							return;
						}
						const count = questions.reduce((a,b) => (b.passageId === q.passageId ? a+1 : a),0); //b는 객체
						//시작 인덱스
						const startIndex = questions.findIndex(b => b.passageId === q.passageId) + 1;
						//끝 인덱스
						const endIndex = startIndex + count - 1;
						//범위
						const rangeText = startIndex === endIndex ? `${startIndex}` : `${startIndex}~${endIndex}`;

						//console.log(`${count}`);
						questionHTML += `
						<div class="view-que-box">
							<div class="que-top">
								<div class="title">
									<span class="num">${rangeText}</span>
								</div>
							</div>
							<div class="view-que">
								<div class="que-bottom">
									<div class="passage-area">
										${q.passageUrl ? `<img src="${q.passageUrl}" alt="지문 이미지"/>` : ""}
									</div>
								</div>
							</div>
						</div>
					`;
					}
					questionHTML +=`
					<div class="view-que-box">
							<div class="que-top">
								<div class="title">
									<span class="num">${index+1}</span> <!--문제 순서 -->
									<div class="que-badge-group">
										<span class="que-badge yellow">${q.difficultyName}</span> <!--문제 난이도 -->
										<span class="que-badge gray">${q.questionFormName}</span> <!--문제 형태 -->
									</div>
								</div>
								<div class="btn-wrap">
									<button type="button" class="btn-error pop-btn" data-pop="error-report-pop"></button>
									<button type="button" class="btn-delete"></button>
								</div>
							</div>
							<div class="view-que">
								<div class="que-content">
									<p class="txt">
									<!-- q: 질문 데이터 영역 -->
									${q.questionUrl ? `<img src="${q.questionUrl}" alt="질문 이미지"/>` : ""}
									<!-- q: 질문 데이터 영역 -->
									</p>
								</div>
								<div class="que-bottom">
									<div class="data-area">
										<div class="que-info">
											${q.explainUrl ? `<p class="answer"><span class="label">해설</span></p>` :  ""}
											<div class="data-answer-area">
											<!-- s: 해설 데이터 영역 -->
											<div class="paragraph" style="text-align: Justify">
											<span class="txt">
												${q.explainUrl ? `<img src="${q.explainUrl}" alt="해설 이미지"/>` : ""}
											</span>
											</div>
											<!-- e: 해설 데이터 영역 -->
										</div>
									</div>
								</div>
								<div class="data-area type01">
									<div class="que-info">
									${q.answerUrl ? `<p class="answer"><span class="label">정답</span></p>` :  ""}
										<div class="data-answer-area">
											<!-- s: 정답 데이터 영역 -->
											<div class="paragraph" style="text-align: Justify">
											<span class="txt">
											${q.answerUrl ? `<img src="${q.answerUrl}" alt="정답 이미지"/>` : ""}
											</span>
											</div>
											<!-- e: 정답 데이터 영역 -->
										</div>
									</div>
									<button type="button" class="btn-similar-que btn-default"><i class="similar"></i> 유사 문제</button>
								</div>
							</div>
						</div>
						<div class="que-info-last">
						<p class="chapter">${q.largeChapterName}>${q.mediumChapterName}>${q.smallChapterName}>${q.topicChapterName}</p>
						</div>
					</div>
					`;
					container.insertAdjacentHTML("beforeend", questionHTML);
				});
			}

			// 페이지 로드 시 API 요청
			document.addEventListener("DOMContentLoaded", getQuestionInfo);



				//난이도 별 문항 수/총 문항 수 노출
				function getLevelCnt(questionFormCode) {
					if (questionFormCode) {

					}
				}

				// // tooltip hover
				// let tipBtns = $(".btn-tip");

				// $(function () {
				// 	tipBtns.on("mouseover", function () {
				// 		let _this = $(this);
				// 		let _tooltip = _this.next(".tooltip"); // 툴팁 요소를 바로 뒤에 있는 요소로 찾아옴
				// 		let _tooltipPosition = _this.offset().top; // 버튼(_this)의 전체 문서에서의 위치값을 가져옴

				// 		console.log(_tooltipPosition);

				// 		if (_tooltipPosition > 490) {
				// 			_tooltip.css("top", "-130px"); // 툴팁 위치 변경
				// 			_tooltip.addClass("before-active"); // 클래스 추가
				// 		}
				// 	});
				// });
				$(function () {
					let _leg = $('.view-que').length;
					let arr = [];

					viewListFunc();

					$(".view-que-list").change(function () {
						let _leg = $('.view-que').length;
						let arr = [];

						viewListFunc();
					})

					function viewListFunc() {
						$('.col').on('click', function () {

							let _idx = $(this).index();

							for (var i = 0; i < _leg; i++) {
								arr.push($('.view-que').eq(i).offset().top - 280);
							}

							console.log(arr);

							$('.view-que-list').animate({
								scrollTop: arr[_idx]
							}, 400);

							let _this = $(this);
							if (!_this.hasClass('active')) {
								_this.parents('.test.ui-sortable').find('.col').removeClass('active');
								_this.addClass('active');
								$('.view-que-box').removeClass('active');
								$('.view-que-box').eq(_idx).addClass('active');
							}
							;
						})
					}
				})
		</script>
	</div>
</body>
</html>