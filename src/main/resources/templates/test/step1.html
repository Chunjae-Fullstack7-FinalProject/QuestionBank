<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T셀파 문제은행</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/inc/css/font.css">
    <link rel="stylesheet" href="/inc/css/reset.css">
    <link rel="stylesheet" href="/inc/css/common.css">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <script src="/inc/js/common.js"></script>
    <style>
        .cursorDefault button {
            cursor: default;
        }
        label::before {
            cursor: pointer;
        }
        .cursorDefault_1 {
            cursor: default;
        }
        .disappear {
            display:none;
        }
    </style>
</head>

<body>
<div id="wrap" class="full-pop-que">
    <div class="full-pop-wrap">
        <!-- 여기가 상단 공통 영역. 현재 STEP 정보 + 나가기 버튼 -->
        <div class="pop-header">
            <ul class="title">
                <li class="active">STEP 1 단원선택</li>
                <li>STEP 2 문항 편집</li>
                <li>STEP 3 시험지 저장</li>
                <li id="test">test</li>
            </ul>
            <button type="button" class="del-btn" onclick="winClose()"></button>
            <script>
                function winClose() {
                    if (confirm('이 페이지에서 나가시겠습니까?')) {
                        window.open('', '_self', '').close();
                    }
                }
            </script>
        </div>
        <div class="pop-content">
            <div class="view-box">
                <!-- 교과서 정보 + STEP따라 버튼 -->
                <div class="view-top">
                    <div class="paper-info">
                        <!--여기는 title, 저자, 교육과정연도...는 파싱해서 넣어야 함-->
                        <span class="subject" th:text="${textbookDetailDTO.getSubjectName()}"></span>
                        <span th:text="${textbookDetailDTO.getCurriculumName()}"></span>
                    </div>
                </div>
                <!-- 여기가 바뀌는 영역-->
                <div class="view-bottom">
                    <div class="view-box-wrap">
                        <div class="unit-box-wrap">
                            <div class="unit-box">
                                <div class="unit-cnt scroll-inner">
                                    <div class="title-top">
                                        <span>단원정보</span>
                                        <!-- 전체 선택 체크박스 -->
                                        <input type="checkbox" id="checkAll" class="allCheck">
                                        <label for="checkAll">전체선택</label>
                                    </div>
                                    <ul id="chapter-tree" >
                                        <li th:each="large : ${largeList}" class="depth01">
                                            <!-- 대단원 -->
                                            <div class="check-group title">
                                                <div class="title-chk">
                                                    <input type="checkbox" th:id="${large.largeChapterId}" class="que-allCheck depth01" data-depth="1">
                                                    <label th:for="${large.largeChapterId}">
                                                        <button type="button" class="dep-btn active" th:text="${large.largeChapterName}">대단원 이름</button>
                                                    </label>
                                                </div>
                                            </div>
                                            <!-- 대단원 끝 -->

                                            <div class="depth02">
                                                <!-- 중단원 -->
                                                <div th:each="medium : ${large.mediumList}">
                                                    <div class="check-group">
                                                        <input type="checkbox" th:id="${medium.mediumChapterId}" class="que-allCheck depth02" data-depth="2">
                                                        <label th:for="${medium.mediumChapterId}">
                                                            <button type="button" class="dep-btn active" th:text="${medium.mediumChapterName}">중단원 이름</button>
                                                        </label>
                                                    </div>

                                                    <div class="depth03">
                                                        <!-- 소단원 -->
                                                        <div th:each="small : ${medium.smallList}">
                                                            <div class="check-group">
                                                                <input type="checkbox" th:id="${small.smallChapterId}" class="que-allCheck depth03" data-depth="3">
                                                                <label th:for="${small.smallChapterId}">
                                                                    <button type="button" class="dep-btn active" th:text="${small.smallChapterName}">소단원 이름</button>
                                                                    <em th:id="${small.smallChapterId}" style="color:#5670dc;">(0)</em>
                                                                </label>
                                                            </div>

                                                            <div class="depth04">
                                                                <!-- 토픽 -->
                                                                <div th:each="topic : ${small.topicList}">
                                                                    <div class="check-group">
                                                                        <input type="checkbox" th:data-large="${large.largeChapterId}" th:data-middle="${medium.mediumChapterId}" th:data-small="${small.smallChapterId}" th:id="${topic.topicChapterId}" class="que-allCheck depth04" data-depth="4">
                                                                        <label th:for="${topic.topicChapterId}">
                                                                            <button type="button" class="active" th:text="${topic.topicChapterName}">토픽 이름</button>
                                                                            <em th:id="${topic.topicChapterId}" style="color:#5670dc;">(0)</em>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- 소단원 끝 -->
                                                    </div>
                                                </div>
                                                <!-- 중단원 끝 -->

                                            </div>
                                        </li>
                                    </ul>
                                </div>


                            </div>
                        </div>
                        <div class="type-box-wrap cursorDefault">
                            <div class="type-box scroll-inner ">
                                <div class="title-top">
                                    <span>출제옵션</span>
                                </div>
                                <div class="box">
                                    <div class="title-wrap">
                                        <span class="tit-text">문제 수<em>최대 30문제</em></span>
                                    </div>
                                    <div class="count-area">
                                        <div class="btn-wrap" id="btn-num-group">
                                            <button type="button" class="btn-line" id="q_10" disabled>10</button>
                                            <button type="button" class="btn-line" id="q_15" disabled>15</button>
                                            <button type="button" class="btn-line" id="q_20" disabled>20</button>
                                            <button type="button" class="btn-line" id="q_25" disabled>25</button>
                                            <button type="button" class="btn-line" id="q_30" disabled>30</button>
                                        </div>
                                        <div class="input-area">
                                            <span class="num">총 <input type="text" id="txt-exam-num" value="" disabled> 문제</span>
                                            <div class="txt" id="questionCntMessage"></div>
                                        </div>

                                    </div>
                                </div>
                                <div class="box">
                                    <div class="title-wrap" >
                                        <span class="tit-text">출처</span>
                                        <div class="right-area">
                                        </div>
                                    </div>
                                    <div class="btn-wrap multi" id="origin-btn-group">
                                        <button type="button" class="btn-line" id="origin_teacher" disabled>교사용(교사용 DVD, 지도서, 신규 개발 등)</button>
                                        <button type="button" class="btn-line" id="origin_student" disabled style="cursor:default; background-color: #eaeaea">학생용(자습서, 평가문제집 등)</button>
                                    </div>
                                </div>
                                <div class="box">
                                    <div class="title-wrap">
                                        <span class="tit-text">평가 영역</span>
                                        <div class="right-area">
                                        </div>
                                    </div>

                                    <div class="btn-wrap multi" id="evaluationList">
                                        <!-- 동적 -->
                                    </div>

                                </div>
                                <div class="box">
                                    <div class="title-wrap">
                                        <span class="tit-text">문제 형태</span>
                                        <div class="right-area">
                                        </div>
                                    </div>
                                    <div class="btn-wrap multi" id="type-btn-group">
                                        <button type="button" class="btn-line" disabled data-type="multiple">객관식</button>
                                        <button type="button" class="btn-line" disabled data-type="subjective">주관식</button>
                                    </div>
                                </div>
                                <div class="box">
                                    <div class="title-wrap">
                                        <span class="tit-text">난이도 구성</span>
                                    </div>
                                    <div class="step-wrap" id="level-btn-group">
                                        <button type="button" class="btn-line type02 color01" data-step="1" disabled>최하</button>
                                        <button type="button" class="btn-line type02 color02" data-step="2" disabled>하</button>
                                        <button type="button" class="btn-line type02 color03" data-step="3" disabled>중</button>
                                        <button type="button" class="btn-line type02 color04" data-step="4" disabled>상</button>
                                        <button type="button" class="btn-line type02 color05" data-step="5" disabled>최상</button>
                                    </div>
                                </div>
                                <div class="box">
                                    <div class="title-wrap">
											<span class="tit-text">난이도별 문제 수
												<button type="button" id="btn-icon2" class="btn-icon2 pop-btn" data-pop="que-range-pop" disabled><i class="setting"></i></button>
											</span>
                                    </div>
                                    <div class="range-wrap" id="level-distribution-btn-group">
                                        <span class="range color01" data-step="1" data-level="최하" data-count="0" >최하(n)</span>
                                        <span class="range color02" data-step="2" data-level="하" data-count="0">하(n)</span>
                                        <span class="range color03" data-step="3" data-level="중" data-count="0">중(n)</span>
                                        <span class="range color04" data-step="4" data-level="상" data-count="0">상(n)</span>
                                        <span class="range color05" data-step="5" data-level="최상" data-count="0">최상(n)</span>
                                    </div>
                                </div>

                            </div>
                            <div class="bottom-box">
                                <p class="total-num" id="total-num" style="display: none;">총 <span id="total-num-val"></span>문제</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="step-btn-wrap">
            <button type="button" class="btn-step" id="step0">출제 방법 선택</button>
            <button type="button" class="btn-step next" id="nextBtn" data-pop="que-pop">STEP2 문항 편집</button>
        </div>


    </div>
    <div class="dim"></div>

    <!-- 난이도 문제 수 설정 팝업 -->
    <div class="pop-wrap range-type" data-pop="que-range-pop">
        <div class="pop-inner">
            <div class="pop-header">
                <span>난이도별 문제 수 설정</span>
                <button type="button" class="pop-close"></button>
            </div>
            <div class="pop-content">
                <span class="txt">문제 수를 입력하여<br> 난이도별 문제 수를 조정하세요.</span>

                <div class="range-wrap" id="range-wrap">
                    <!-- S: 문제 수 맞지 않을 시 .fail 클래스 추가 -->
<!--                    <div class="range color01 fail">-->
<!--                        <span class="color01">최하</span>-->
<!--                        <input type="number">-->
<!--                    </div>-->
                    <div class="range color02">
                        <span class="color02">하</span>
                        <input type="number" data-step="2" value="0">
                    </div>
                    <div class="range color03">
                        <span class="color03">중</span>
                        <input type="number" data-step="3" value="0">
                    </div>
                    <div class="range color04">
                        <span class="color04">상</span>
                        <input type="number" data-step="4" value="0">
                    </div>
<!--                    <div class="range color05">-->
<!--                        <span class="color05">최상</span>-->
<!--                        <input type="number">-->
<!--                    </div>-->
                    <div class="range total">
                        <span>합계</span>
                        <span class="num" id="range-total"></span>
                    </div>
                    <!-- E: 문제 수 맞지 않을 시 .fail 클래스 추가 -->
                </div>
            </div>
            <div class="pop-footer">
                <button id="resetBtn">초기화</button>
                <button class="cursorDefault_1" id="savePop">저장</button>
            </div>
        </div>
    </div>

    <!-- 문항 충족하지 않을 시 노출 팝업 -->
    <div class="pop-wrap range-type02" data-pop="que-pop" id="quePop">
        <div class="pop-inner">
            <div class="pop-header">
                <span>문항 구성 자동 변경</span>
                <button type="button" class="pop-close"></button>
            </div>
            <div class="pop-content">
                <span class="txt">사용자가 원하는 문항 구성을 할 수 없어<br>문항 구성이 자동으로 변경되었습니다.</span>
                <div class="range-wrap" id="rangeWrap">
<!--                    <div class="range">-->
<!--                        <span class="color01">최하</span>-->
<!--                        <span class="num">2</span>-->
<!--                    </div>-->

                    <div class="range"  data-step="2">
                        <span class="color02">하</span>
                        <span class="num" id="displayLow"></span>
                    </div>
                    <div class="range" data-step="3">
                        <span class="color03">중</span>
                        <span class="num" id="displayMiddle" ></span>
                    </div>
                    <div class="range" data-step="4">
                        <span class="color04">상</span>
                        <span class="num" id="displayHigh" ></span>
                    </div>

<!--                    <div class="range">-->
<!--                        <span class="color05">최상</span>-->
<!--                        <span class="num">2</span>-->
<!--                    </div>-->

                    <div class="range total">
                        <span>합계</span>
                        <span class="num" id="displayTotal">20</span>
                    </div>
                </div>
                <span class="txt">해당 문제 구성으로 출제하시겠습니까?</span>
            </div>
            <div class="pop-footer">
                <button class="pop-close">취소</button>
                <button class="pop-close" id="nextBtn2">확인</button>
            </div>
        </div>
    </div>
    <!-- 문항 충족하지 않을 시 노출 팝업 -->
    <!-- 문항 수가 0일 때-->
    <div class="pop-wrap range-type03" data-pop="que-zero-pop" id="zeroPop">
        <div class="pop-inner" style="width:60vh;height:21vh;">
            <div class="pop-header">
                <span>문제 정보 없음</span>
                <button type="button" class="pop-close"></button>
            </div>
            <div class="pop-content" style="height:10vh; text-align:center; display: flex; align-items: center; justify-content: center;">
                <span class="txt" style="">사용자가 선택한 단원 정보, 출제 옵션의 총 문항 수가 '0'입니다.<br>단원 선택 추가 및 출제 옵션을 변경해 주세요.</span>
            </div>
            <div class="pop-footer">
                <button class="pop-close">확인</button>
            </div>
        </div>
    </div>
    <!-- 문항 수가 0일 때-->
</div>

<!-- (1) > 펼쳐짐, (2) 체크박스, (3) 난이도 구성 버튼 선택 시 난이도별 문제 수 display -->
<script>
    $(function () {

        // depth --> 펼쳐지는 거
        let depBtn = $('.dep-btn');
        function depFunc() {
            let _this = $(this);

            if (!_this.hasClass('active')) { //여기가 active가 없을 때. 즉, 이미 펼쳐져 있는 상황.
                _this.addClass('active');
                _this.parents('.check-group').next('div').stop().slideUp('fast');
            } else {
                _this.removeClass('active');
                _this.parents('.check-group').next('div').stop().slideDown('fast');
            }

            _this.parents('.check-group').toggleClass('on');
        }
        depBtn.on('click', depFunc);

        // 전체 선택 체크박스 로직 --> 맹글어둔 거 사용
        $('#checkAll').on('change', function () {
            const isChecked = $(this).prop('checked'); // 전체 선택 여부
            const largeCheckboxes = $('#chapter-tree').find('.depth01'); // 모든 대단원 체크박스

            // 대단원 체크박스를 클릭한 것처럼 처리
            largeCheckboxes.each(function () {
                $(this).prop('checked', !isChecked).trigger('click'); // 상태 변경 후 클릭 이벤트 트리거
            });
        });
        // 전체 선택 체크박스 선택 시에는 대단원이 모두 체크되었는지만 확인
        $('#chapter-tree').on('change', '.depth01', function () {
            const largeCheckboxes = $('#chapter-tree').find('input[type=checkbox].depth01'); // 모든 대단원 체크박스
            const isAllChecked = largeCheckboxes.length === largeCheckboxes.filter(':checked').length; // 모두 체크 여부 확인
            $('#checkAll').prop('checked', isAllChecked); // 전체 선택 상태 업데이트
        });


        // 모든 체크박스 선택자
        let queChkAll = $('.que-allCheck');
        // depth01, 02, 03 체크박스 선택 시 펼쳐지게 하기
        function queCheckFunc() {
            let _this = $(this);
            let parentGroup = _this.parents('.check-group');
            let childCheckboxes = parentGroup.next('div').find('input[type=checkbox]');
            const depth = parseInt(_this.data('depth')); // 현재 체크박스 깊이

            if (_this.prop('checked')) {
                _this.parents().next('ul').find('input[type=checkbox]').prop('checked', true);
            } else {
                _this.parents().next('ul').find('input[type=checkbox]').prop('checked', false);
            }


            if (_this.hasClass('depth01')) {
                if (_this.prop('checked')) {

                    _this.parents('.check-group').next('.depth02').find('input[type=checkbox]').prop('checked', true);
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('input[type=checkbox]').prop('checked', true);
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.depth04').find('input[type=checkbox]').prop('checked', true);

                    _this.next('label').find('button').removeClass('active');
                    _this.parents('.check-group').next('.depth02').find('button').removeClass('active');

                    _this.parents('.check-group').next('.depth02').stop().slideDown('fast');
                    _this.parents('.check-group').next('.depth02').find('.depth03').stop().slideDown('fast');
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.depth04').stop().slideDown('fast');

                    _this.closest('.check-group').addClass('on');
                    _this.parents('.check-group').next('.depth02').find('.check-group').addClass('on');
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.check-group').addClass('on');

                } else {
                    _this.parents('.check-group').next('.depth02').find('input[type=checkbox]').prop('checked', false);
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('input[type=checkbox]').prop('checked', false);
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.depth04').find('input[type=checkbox]').prop('checked', false);

                    _this.next('label').find('button').addClass('active');
                    _this.parents('.check-group').next('.depth02').find('button').addClass('active');

                    _this.parents('.check-group').next('.depth02').stop().slideUp('fast');
                    _this.parents('.check-group').next('.depth02').find('.depth03').stop().slideUp('fast');
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.depth04').stop().slideUp('fast');

                    _this.closest('.check-group').removeClass('on');
                    _this.parents('.check-group').next('.depth02').find('.check-group').removeClass('on');
                    _this.parents('.check-group').next('.depth02').find('.depth03').find('.check-group').removeClass('on');
                }
            }


            else if (_this.hasClass('depth02')) {
                if (_this.prop('checked')) {

                    _this.parents('.check-group').next('.depth03').find('input[type=checkbox]').prop('checked', true);
                    _this.parents('.check-group').next('.depth03').find('.depth04').find('input[type=checkbox]').prop('checked', true);

                    _this.next('label').find('button').removeClass('active');
                    _this.parents('.check-group').next('.depth03').find('button').removeClass('active');

                    _this.parents('.check-group').next('.depth03').stop().slideDown('fast');
                    _this.parents('.check-group').next('.depth03').find('.depth04').stop().slideDown('fast');

                    _this.closest('.check-group').addClass('on');
                } else {

                    _this.parents('.check-group').next('.depth03').find('input[type=checkbox]').prop('checked', false);
                    _this.parents('.check-group').next('.depth03').find('.depth04').find('input[type=checkbox]').prop('checked', false);

                    _this.next('label').find('button').addClass('active');
                    _this.parents('.check-group').next('.depth03').find('button').addClass('active');

                    _this.parents('.check-group').next('.depth03').stop().slideUp('fast');
                    _this.parents('.check-group').next('.depth03').find('.depth04').stop().slideUp('fast');

                    _this.closest('.check-group').removeClass('on');
                }
            }

// 소단원 체크박스 클릭 시
            else if (_this.hasClass('depth03')) {
                if (_this.prop('checked')) {
                    _this.parents('.check-group').next('.depth04').find('input[type=checkbox]').prop('checked', true);
                    _this.next('label').find('button').removeClass('active');
                    _this.parents('.check-group').next('.depth04').stop().slideDown('fast');
                    _this.closest('.check-group').addClass('on');
                } else {

                    _this.parents('.check-group').next('.depth04').find('input[type=checkbox]').prop('checked', false);
                    _this.next('label').find('button').addClass('active');
                    _this.parents('.check-group').next('.depth04').stop().slideUp('fast');
                    _this.closest('.check-group').removeClass('on');
                }
            }
        }
        queChkAll.on('click', queCheckFunc);

        //부모 체크박스 업데이트
        queChkAll.on('change', function () {
            let _this = $(this); // 현재 선택된 체크박스
            let parentCheckBox; // 상위 체크박스
            let childCheckboxes; // 하위 체크박스들

            // depth04, depth03, depth02의 상위 체크박스를 찾아 상태를 업데이트
            if (_this.hasClass('depth04')) {
                // depth04인 경우
                parentCheckBox = _this.parents('.depth04').prev('.check-group').find('input[type=checkbox].depth03');
                childCheckboxes = _this.closest('div.depth04').find('input[type=checkbox].depth04'); // depth04 체크박스
            } else if (_this.hasClass('depth03')) {
                // depth03인 경우
                parentCheckBox = _this.parents('.depth03').prev('.check-group').find('input[type=checkbox].depth02');
                childCheckboxes = _this.closest('div.depth03').find('input[type=checkbox].depth03'); // depth03 체크박스
            } else if (_this.hasClass('depth02')) {
                // depth02인 경우
                parentCheckBox = _this.parents('.depth02').prev('.check-group.title').find('input[type=checkbox].depth01');
                childCheckboxes = _this.closest('div.depth02').find('input[type=checkbox].depth02'); // depth02 체크박스
            }

            // 상위 체크박스 상태 업데이트 함수 호출
            updateAllParentCheckboxes(_this);
        });
        //부모 체크박스 업데이트
        function updateAllParentCheckboxes(element) {
            let currentDepth = parseInt(element.data('depth')); // 현재 체크박스의 depth

            while (currentDepth > 1) {
                let parentDepth = currentDepth - 1; // 상위 depth 계산
                const parentGroup = element.parents(`.depth0${currentDepth}`).prev(`.depth0${parentDepth}`);
                const parentCheckbox = element.parents(`.depth0${currentDepth}`).prev('.check-group').find(`input[type=checkbox].depth0${parentDepth}`);
                const siblingCheckboxes = element.closest(`div.depth0${currentDepth}`).find(`input[type=checkbox].depth0${currentDepth}`);
                if (!parentCheckbox.length) break; // 부모 체크박스가 없으면 종료

                // 하위 체크박스 상태 확인
                const allChecked = siblingCheckboxes.length === siblingCheckboxes.filter(':checked').length;

                // 상위 체크박스 상태 동기화
                parentCheckbox.prop('checked', allChecked);

                // 다음 상위로 이동
                element = parentCheckbox;
                currentDepth = parentDepth;
            }
        }


        // 난이도 누르면 아래에 디스플레이
        $(".type-box .box .range").hide();
        let stepBtn = $('.step-wrap .btn-line');
        function stepFunc() {   // 난이도 누르면 디스플레이 되는 거
            let _this = $(this);
            let stepData = _this.data('step');

            _this.toggleClass('active');
            inputCheck();
            if (_this.hasClass('active')) {
                $(".range[data-step='" + stepData + "']").show();
                $('#rangeWrap').find("div[data-step='" + stepData + "']").removeClass('disappear');
            } else {
                $(".range[data-step='" + stepData + "']").hide();
                $('#level-distribution-btn-group').find("span[data-step='" + stepData + "']").attr('data-count', 0);
                $('#rangeWrap').find("div[data-step='" + stepData + "']").addClass('disappear');
                $('#rangeWrap').find("div[data-step='" + stepData + "']").find('span.num').text('');
                $('#range-wrap').find(`input[type=number][data-step=${stepData}]`).val(0);
            }


        }
        stepBtn.on('click', stepFunc);
    });
</script>
<!-- (1) 소단원, 토픽 문항 수 가져와서 바인딩 -->
<script th:inline="javascript">
    const subjectId = [[${subjectId}]]; // 단원 아이디
    document.addEventListener('DOMContentLoaded', itemCounts);
    //소단원, 토픽 문항 수 가져오기
    async function itemCounts() {
        let requestData ={
            "subjectId": subjectId.toString()  //"/bridge/t-sherpa/customExam/count"
        };
        try {
            const response = await fetch('/bridge/t-sherpa/item-img/chapters/item-count', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json(); // JSON 응답 처리
            let smallItemCount = data.listSmallItemCount;
            let topicItemCount = data.listTopicItemCount;

            smallItemCount.forEach(function(item) {
                const inputElement = $(`input[type="checkbox"][data-depth='3'][id=${item.smallChapterId}]`);
                // input 엘리먼트의 부모인 div.check-group에서 em 태그 찾기
                inputElement.closest('div.check-group').find('em').text(`(${item.itemCount})`);
            });

            topicItemCount.forEach(function(item) {
                const inputElement = $(`input[type="checkbox"][data-depth="4"][id="${item.topicChapterId}"]`);
                // input 엘리먼트의 부모인 div.check-group에서 em 태그 찾기
                inputElement.closest('div.check-group').find('em').text(`(${item.itemCount})`);
            });


        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }
    //평가유형 받아오기
    document.addEventListener("DOMContentLoaded", async () => {

        const requestData = {
            "subjectId": subjectId.toString()
        }
        let evaluationList = document.getElementById('evaluationList');
        try {
            const response = await fetch('/bridge/t-sherpa/chapter/evaluation-list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json(); // JSON 응답 처리
            const evaluationListData = data.evaluationList;



            evaluationListData.forEach(data => {
                const domainId = data.domainId;
                const domainName = data.domainName;
                evaluationList.innerHTML += `
                     <button type="button" class="btn-line" data-domain-id="${domainId}" disabled>${domainName}</button>
                `;
            })

        } catch (error) {
            console.error('Error fetching data:', error);
        }

        let _btnMul = $(".btn-wrap.multi .btn-line");

        _btnMul.click(function () {
            $(this).toggleClass("active");
            btnClickFunc.return(false);
        });

        let _btn = $(".btn-wrap .btn-line");

        function btnClickFunc() {
            let _this = $(this);
            if (!_this.hasClass("active")) {
                _this.parents(".btn-wrap").find(".btn-line").removeClass("active");
                _this.addClass("active");
            }
        }

        _btn.on("click", btnClickFunc);

    });
</script>
<!-- (1) 체크박스 선택 시 우측 영역 활성화/비활성화, (2)문항 수, input관련 js, (3) 난이도별 문제 수 상세조정 -->
<script>
    //체크박스 선택 시 우측 영역 활성화
    let checkBox = $('div.unit-cnt').find('input[type=checkbox]');
    checkBox.on('change', function() {
        const checkedCount = checkBox.filter(':checked').length;
        if(checkedCount > 0) {
            activeProblemCnt();
        } else {
            deactivateProblemCnt();
        }
    })
    //비활성화 함수
    function deactivateProblemCnt() {
        // 커서 비활성화 처리
        $(".type-box-wrap").addClass("cursorDefault");
        $(".btn-wrap .btn-line").addClass('active');

        // 문제수 비활성화
        $("#btn-num-group button").attr("disabled", true);
        $("#txt-exam-num").attr("disabled", true);
        $("#q_30").removeClass("active");
        $("#q_25").removeClass("active");
        $("#q_20").removeClass("active");
        $("#q_15").removeClass("active");
        $("#q_10").removeClass("active");
        $("#txt-exam-num").val("");
        $("#txt-exam-num").text("");
        $("#txt-exam-num").css("border-color", "");
        $("#questionCntMessage").text("");
        $("#total-num").hide();
        $("#total-num-val").text("");

        // 출처 비활성화
        $("#origin_teacher").attr("disabled", true);
        $("#origin_teacher").removeClass("active");
        $('#origin_student').removeClass('active');

        // 평가영역 비활성화
        $("#evaluationList button").attr("disabled", true);
        $("#evaluationList button").removeClass("active");

        // 문제형태 비활성화
        $("#type-btn-group button").attr("disabled", true);
        $("#type-btn-group button").removeClass("active");

        $('#btn-icon2').attr("disabled",true);

        // 난이도 구성 비활성화
        $("#btn-pop-que-range").attr("disabled", true);
        $("#level-btn-group :button").attr("disabled", true);
        $("#level-btn-group .btn-line").addClass('active');
        $("#level-btn-group button").removeClass("active");

        // TODO 230914 임시 최상, 최하 난이도 비활성화 복구
        $("#level-btn-group button").eq(0).attr("disabled", true);
        $("#level-btn-group button").eq(0).css("cursor", "default");
        $("#level-btn-group button").eq(4).attr("disabled", true);
        $("#level-btn-group button").eq(4).css("cursor", "default");

        // 난이도별 문제수 비활성화
        $("#level-distribution-btn-group span").eq(1).hide();
        $("#level-distribution-btn-group span").eq(2).hide();
        $("#level-distribution-btn-group span").eq(3).hide();

        active = false;
    }
    //활성화 함수
    function activeProblemCnt() {
        // 커서 활성화 처리
        $(".type-box-wrap").removeClass("cursorDefault");
        $(".btn-wrap .btn-line").removeClass('active');

        //문제수 활성(디폴트 : 30)
        $("#btn-num-group button").attr("disabled", false);
        $("#txt-exam-num").attr("disabled", false);
        $("#q_30").addClass("active");
        $("#txt-exam-num").val(30);
        $("#txt-exam-num").text("30");
        // $("#txt-exam-num").data("columns", 30); 이건모임?
        $("#total-num").show();
        $("#total-num-val").text("30");

        //출처 활성(디폴트 : 교사용)
        $("#origin_teacher").attr("disabled", false);
        $("#origin_teacher").addClass("active");

        //평가영역 활성(디폴트 : all)
        $("#evaluationList button").attr("disabled", false);
        $("#evaluationList button").addClass("active");

        //문제형태 활성(디폴트 : all)
        $("#type-btn-group button").attr("disabled", false);
        $("#type-btn-group button").addClass("active");

        // 난이도 구성(디폴트 : 하,중,상)
        $("#btn-pop-que-range").attr("disabled", false);
        $("#level-btn-group :button").attr("disabled", false);
        $("#level-btn-group .btn-line").removeClass('active');

        $("#level-btn-group button").eq(1).addClass("active");
        $("#level-btn-group button").eq(2).addClass("active");
        $("#level-btn-group button").eq(3).addClass("active");

        $('#btn-icon2').attr("disabled",false);

        //TODO 230914 임시 최상, 최하 난이도 비활성 처리 230914x
        $("#level-btn-group button").eq(0).attr("disabled", true);
        $("#level-btn-group button").eq(0).css("cursor", "default");
        $("#level-btn-group button").eq(4).attr("disabled", true);
        $("#level-btn-group button").eq(4).css("cursor", "default");
        //TODO 230914 임시 최상, 최하 난이도 비활성 처리 230914

        //난이도별 문제수

        $("#level-distribution-btn-group span").eq(1).show();
        $("#level-distribution-btn-group span").eq(2).show();
        $("#level-distribution-btn-group span").eq(3).show();


        active=true;
        inputCheck();
    }

    //문제 수 버튼 눌렀을 때, 문제 수 input에 반영되는 함수
    $("#btn-num-group button").on("click", function () {
        $("#txt-exam-num").val($(this).text());
        $("#txt-exam-num").css("border-color", "");
        $("#total-num").show();
        $("#total-num-val").text($(this).text());
        inputCheck()
    });

    // input 컨트롤
    const _input = $('#txt-exam-num');
    _input.on('keyup', questionCountCheck);
    _input.on('keydown', numberCheck);
    function numberCheck() {
        let inputNum = parseInt($("#txt-exam-num").val());

        // 음수이거나 숫자가 아닐 때,
        if (inputNum <=0 || !Number.isInteger(Number($("#txt-exam-num").val()))) {
            $("#txt-exam-num").css("border-color", "#ff3b00");
            $("#txt-exam-num").val("");
            return false;
        }
    }
    function questionCountCheck() {
        $("#btn-num-group button").removeClass("active");
        $("#questionCntMessage").text("");
        $("#txt-exam-num").css("border-color", "");
        $("#total-num").hide();

        let maxNum = 30;
        let inputNum = parseInt($("#txt-exam-num").val());

        // // 음수이거나 숫자가 아닐 때,
        // if (inputNum <=0 || !Number.isInteger(Number($("#txt-exam-num").val()))) {
        //     $("#txt-exam-num").css("border-color", "#ff3b00");
        //     $("#txt-exam-num").val("");
        //     return false;
        // }



        if (inputNum > maxNum) {
            alert("문항은 최대 " + maxNum + "문제 까지만 출제 가능합니다.");
            $("#txt-exam-num").css("border-color", "#ff3b00");
            $("#txt-exam-num").val("");
            return false;
        }

        // dafault 문항수로 체크되면, 버튼 활성화
        switch (inputNum) {
            case 10:
                $("#q_10").addClass("active");
                break;
            case 15:
                $("#q_15").addClass("active");
                break;
            case 20:
                $("#q_20").addClass("active");
                break;
            case 25:
                $("#q_25").addClass("active");
                break;
            case 30:
                $("#q_30").addClass("active");
                break;
        }

        if (inputNum % 5 === 0) {
            $("#questionCntMessage").text("");
            inputCheck();
            $("#total-num").show();
            $("#total-num-val").text(inputNum);
        } else {
            $("#txt-exam-num").css("border-color", "#ff3b00");
            $("#questionCntMessage").text("* 5의 배수로 입력해주세요.");
            inputCheck();
        }
    }
    // 문제 수 input 에 따라서 난이도별 문제 수 계산하기. 최상최하 포함해도 동작됨.
    function inputCheck() {
        const _input = $('#txt-exam-num');
        const levelBtnGroup = $('#level-btn-group'); //최하 하 중 상 최상
        const selectedCnt = levelBtnGroup.find('button.btn-line').filter('.active').length; // active 인 개수
        const selectedLevel = levelBtnGroup.find('button.btn-line').filter('.active'); // active 인 각각의 요소들

        if(_input.val() % selectedCnt === 0){
            selectedLevel.each(function() { //active 인 요소들 forEach
                const step = $(this).data('step');
                const button = $('#level-distribution-btn-group').find(`span[data-step=${step}]`);
                const stepLevel = button.data('level');
                button.text(`${stepLevel}${Math.floor(_input.val()/selectedCnt)}`);




                //data-count 에도 추가
                button.data('count',Math.floor(_input.val() / selectedCnt));
                button.attr('data-count', Math.floor(_input.val() / selectedCnt));

                //팝업에도 추가 --> 만약 active가 없어진다면, popUp의 input을 0으로 초기화해줄 필요가 있음
                const popInput = $('#range-wrap').find(`input[type=number][data-step=${step}]`);
                const stepValue = Math.floor(_input.val() / selectedCnt);
                popInput.val(stepValue);

            });
        } else if (_input.val() % selectedCnt > 0) {
            const remainder = _input.val() % selectedCnt;
            let additionalIndex = 0; // 추가되는 곳

            selectedLevel.each(function () {
                const step = $(this).data('step');
                const button = $('#level-distribution-btn-group').find(`span[data-step=${step}]`);
                const stepLevel = button.data('level');
                //팝업에도 추가
                const popInput = $('#range-wrap').find(`input[type=number][data-step=${step}]`);


                const baseValue = Math.floor(_input.val() / selectedCnt);

                //더해줄거
                const additionalValue = additionalIndex < remainder ? 1 : 0;
                if (additionalValue > 0) {
                    additionalIndex++;
                }

                button.text(`${stepLevel}${baseValue + additionalValue}`);
                // 팝업에도 반영
                popInput.val(baseValue + additionalValue);
                button.data('count',(baseValue + additionalValue));
                button.attr('data-count', (baseValue + additionalValue));
            });
        }

    }

    // 난이도별 문제 수 팝업

    //기존 문제 총합
    let initTotal;
    //계산될 총합
    const popSum = $('#range-total');

    const setBtn = $('i.setting');
    setBtn.on('click', initiate);

    // 시작, 초기화 함수
    function initiate() {
        //총합 초기화
        initTotal = Number($('#total-num-val').text());
        popSum.text(initTotal);
        inputCheck();
        $('#savePop').removeClass('cursorDefault_1'); // 커서 default 로 바꿈
        $('#savePop').removeClass('disabled');
        popSum.closest('div#range-wrap').find('.range').removeClass('fail');

    }

    const popInput = $('#range-wrap').find(`input[type=number]`);
    popInput.on('keyup',popCheck);

    function popCheck() {
        const popInput = $('#range-wrap').find(`input[type=number]`);

        //validation
        popInput.each(function() {
            let value = $(this).val();
            value = value.replace(/\D/g, ''); // 숫자만 남기기
            if (value > 30) {
                value = 30;
            }
            if (value < 0) {
                value = '';
            }
            $(this).val(value);
        });


        //합계 확인
        let sum = 0;
        popInput.each(function() {
            sum += Number($(this).val());
        })
        popSum.text(sum);
        if(Number(popSum.text()) !== initTotal) {
            popSum.closest('div#range-wrap').find('.range').addClass('fail');
        } else {
            popSum.closest('div#range-wrap').find('.range').removeClass('fail');
        }

        //저장 버튼 UI
        if(popSum.closest('div#range-wrap').find('.range').hasClass('fail')){ //fail 이 있을 때,
            const savePop = $('#savePop').addClass('cursorDefault_1'); // 커서 default 로 바꿈
            $('#savePop').addClass('disabled');
        } else { // fail 클래스 없을 때
            const savePop = $('#savePop').removeClass('cursorDefault_1'); // 커서 default 로 바꿈
            $('#savePop').removeClass('disabled');
        }

    }
    // 초기화 버튼
    const resetBtn = $('#resetBtn');
    resetBtn.on('click', initiate);
    // 저장 버튼
    const saveBtn = $('#savePop');
    saveBtn.on('click', saveFunc);
    function saveFunc() {
        popInput.each(function(){
            const step = $(this).data('step');
            const value = $(this).val();
            const button = $('#level-distribution-btn-group').find(`span[data-step=${step}]`);
            const level = button.data('level');
            const buttonM = $('#level-btn-group').find(`button[data-step=${step}]`);

            if(value > 0){
                console.log("됨?");
                buttonM.addClass('active');
                $(".range[data-step='" + step + "']").show();
                $('#rangeWrap').find("div[data-step='" + step + "']").removeClass('disappear');
                button.text(`${level}(${value})`);
                button.data('count',`${value}`);
                button.attr('data-count', `${value}`);
            } else {
                buttonM.removeClass('active');
                console.log("안된 것 같은데?");
                $(".range[data-step='" + step + "']").hide();
                $('#rangeWrap').find("div[data-step='" + step + "']").addClass('disappear');
                $('#rangeWrap').find("div[data-step='" + step + "']").find('span.num').text('');
                button.text(`${level}(${value})`);
                button.data('count',`${value}`);
                button.attr('data-count', `${value}`);
            }
            // inputCheck();
            if(!popSum.closest('div#range-wrap').find('.range').hasClass('fail')){
                popClose();
            }
        });
    }
    //팝업닫기
    function popClose() {
        // this를 현재 호출된 요소로 참조
        let _this = this;

        // .pop-wrap 클래스를 가진 요소를 숨김
        const popWrap = document.querySelector(".pop-wrap");
        if (popWrap) {
            popWrap.style.display = "none";
        }

        // <html> 요소의 overflow 속성을 auto로 설정
        const htmlElement = document.documentElement; // <html> 요소를 가져옴
        htmlElement.style.overflow = "auto";

        // _dim 요소를 점점 사라지게 처리
        const dim = document.querySelector(".dim"); // _dim은 가정된 클래스 이름
        if (dim) {
            dim.style.transition = "opacity 0.5s"; // 서서히 사라지는 효과 추가
            dim.style.opacity = "0";
            // opacity가 0이 되면 display: none 처리
            setTimeout(() => {
                dim.style.display = "none";
            }, 500); // 애니메이션 지속 시간과 맞춤
        }
    }




    //대망의 문제 수 확인
    $('#nextBtn').on('click', finalCheck); //여기 수정해야 함.
    $('#test').on('click',finalCheck);
    async function finalCheck() {
        let txtExamNum = $("#txt-exam-num").val();
        console.log("문제 수 =============>" + txtExamNum);

        if ($('#chapter-tree li input[type="checkbox"]:checked').length < 1) {
            alert("단원을 선택해주세요");
            return false;
        }
        if (txtExamNum === '') {
            alert("문제수를 입력해주세요");
            return false;
        }

        if (Number(txtExamNum) % 5 !== 0) {
            alert("문제 수는 5의 배수로 입력해주세요");
            return false;
        }

        if (!$("#origin-btn-group button").hasClass("active")) {
            alert("출처를 선택해주세요");
            return false;
        }

        if (!$("#evaluationList button").hasClass("active")) {
            alert("평가영역을 선택해주세요");
            return false;
        }

        if (!$("#type-btn-group button").hasClass("active")) {
            alert("문제형태를 선택해주세요");
            return false;
        }

        if (!$("#level-btn-group button").hasClass("active")) {
            alert("난이도를 선택해주세요");
            return false;
        }


        //모든 topic 가져오기
        let minorClassification = [];
        let topicId = {};
        let smallId = {};
        let middleId = {};
        let largeId = {};
        const topicCheckBoxes = $('#chapter-tree').find(`input[type=checkbox].depth04`).filter(':checked');
        topicCheckBoxes.each(function() {
            const topicChapterId = $(this).prop('id');
            const smallChapterId = $(this).data('small');
            const middleChapterId = $(this).data('middle');
            const largeChapterId = $(this).data('large');

            topicId = {
                "subject" : subjectId,
                "large" : largeChapterId,
                "medium" : middleChapterId,
                "small" : smallChapterId,
                "topic" : topicChapterId
            };
            minorClassification.push(topicId);
        });
        console.log("단원정보:",minorClassification);

        //난이도
        let levelCnt = [];
        const levelContainer = $('#level-distribution-btn-group').find('span.range');
        levelContainer.each(function() {
           const value = Number($(this).data('count'));
           if(value !== 0){
               levelCnt.push(30);
           } else {
               levelCnt.push(0);
           }
        });
        console.log("레벨카운트:",levelCnt);
        //평가 영역
        let activityCategoryList = [];
        const evaluationList = $('#evaluationList').find('button');
        evaluationList.each(function() {
           if($(this).hasClass('active')){
               activityCategoryList.push($(this).data('domainId'));
           }
        });
        console.log("평가영역:",activityCategoryList);
        //객관식, 주관식
        let questionForm = '';
        if ($('#type-btn-group').find('button[data-type="multiple"]').hasClass('active')) {
            questionForm = 'multiple';
        }
        if ($('#type-btn-group').find('button[data-type="subjective"]').hasClass('active')) {
            if (questionForm === '') {
                questionForm = 'subjective,descriptive';
            } else {
                questionForm += ',subjective,descriptive';
            }
        }
        console.log("단원정보:",questionForm);


        let requestBody = {};
        requestBody.minorClassification = minorClassification;
        requestBody.levelCnt = levelCnt;
        requestBody.questionForm = questionForm;
        requestBody.activityCategoryList = activityCategoryList;

        console.log("요청:",requestBody);
        if(requestBody.minorClassification.length !== 0){
            try{
                const response = await fetch('/bridge/t-sherpa/item-img/chapters/item-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if(!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                //이제 여기서 처리해줘야 함
                const itemList = data.itemList;
                let low = 0;
                let middle = 0;
                let high = 0;
                itemList.forEach(element =>{
                    switch (element.difficultyCode) {
                        case '02':
                            low += 1;
                            break;
                        case '03':
                            middle += 1;
                            break;
                        case '04':
                            high += 1;
                            break;
                    }
                });
                console.log("응답:",data);
                console.log("하 난이도 개수:",low); // response 중 하 난이도의 개수
                console.log("중 난이도 개수:",middle); // response 중 중 난이도의 개수
                console.log("상 난이도 개수:",high); // response 중 상 난이도의 개수

                const requestLow = $('#level-distribution-btn-group').find(`span[data-step=2]`);
                const requestMiddle = $('#level-distribution-btn-group').find(`span[data-step=3]`);
                const requestHigh = $('#level-distribution-btn-group').find(`span[data-step=4]`);

                console.log("요청 하 난이도 개수:",requestLow.data('count')); //내가 실제로 요청한 하 난이도의 개수
                console.log("요청 중 난이도 개수:",requestMiddle.data('count')); //내가 실제로 요청한 중 난이도의 개수
                console.log("요청 상 난이도 개수:",requestHigh.data('count')); //내가 실제로 요청한 상 난이도의 개수

                const lowCheck = low >= requestLow.data('count');
                const middleCheck = middle >= requestMiddle.data('count');
                const highCheck = high >= requestHigh.data('count');

                console.log("하 난이도, 응답보다 요청이 많니?:",lowCheck); // 응답 >= 요청인지(하)
                console.log("중 난이도, 응답보다 요청이 많니?:",middleCheck); // 응답 >= 요청인지(하)
                console.log("상 난이도, 응답보다 요청이 많니?:",highCheck); // 응답 >= 요청인지(하)

                // 상, 중, 하 모두 request 보다 response 가 더 크다면, response 중 request 개수만큼 가져와서, 넘기기
                if(lowCheck && middleCheck && highCheck){
                    let itemArr = [];
                    let lowCnt = 0;
                    let middleCnt = 0;
                    let highCnt = 0;
                    itemList.forEach(item => {
                       if(requestLow.data('count') > lowCnt && item.difficultyCode === '02'){
                           lowCnt += 1;
                           itemArr.push(item.itemId);
                       }
                        if(requestMiddle.data('count') > middleCnt && item.difficultyCode === '03'){
                            middleCnt += 1;
                            itemArr.push(item.itemId);
                        }
                        if(requestHigh.data('count') > highCnt && item.difficultyCode === '04'){
                            highCnt += 1;
                            itemArr.push(item.itemId);
                        }
                    });
                    console.log("통과 시 넘기는 배열:",itemArr);

                    //step2넘어가기
                    let url = '/customExam/step2';
                    let new_form = $('<form></form>');
                    new_form.attr("name", "new_form");
                    new_form.attr("method", "post");
                    new_form.attr("action", url);
                    let strRequestBody = JSON.stringify(requestBody);
                    new_form.append($('<input/>', {type: 'hidden', name: 'questionIds', value: itemArr}));
                    new_form.append($('<input/>', {type: 'hidden', name: 'strRequestBody', value: strRequestBody}));
                    new_form.appendTo('body');
                    new_form.submit();

                } else {


                    if(low === 0 && middle === 0 && high === 0){
                        let _dim = $(".dim");
                        let _html = $("html , body");
                        let popData = $('#zeroPop').data("pop");
                        _html.css("overflow", "hidden");
                        _dim.fadeIn();
                        $(".pop-wrap[data-pop='" + popData + "']").show();
                    } else {
                        //팝업
                        let _dim = $(".dim");
                        let _html = $("html , body");
                        let popData = $('#quePop').data("pop");
                        _html.css("overflow", "hidden");
                        _dim.fadeIn();
                        $(".pop-wrap[data-pop='" + popData + "']").show();

                        let lowDiff = low - requestLow.data('count');
                        let middleDiff = middle - requestMiddle.data('count');
                        let highDiff = high - requestHigh.data('count');
                        console.log("하, 응답 - 요청:",lowDiff);
                        console.log("중, 응답 - 요청:",middleDiff);
                        console.log("상, 응답 - 요청:",highDiff);
                        let minusTotal = 0;
                        if(lowDiff < 0) {
                            minusTotal += lowDiff;
                        }
                        if(middleDiff < 0){
                            minusTotal += middleDiff;
                        }
                        if(highDiff < 0) {
                            minusTotal += highDiff;
                        }
                        console.log("부족분 총합:",minusTotal);
                        // minusTotal 1씩 더해야됨
                        let itemArr = [];
                        let lowArr = [];
                        let middleArr = [];
                        let highArr = [];
                        itemList.forEach(item =>{
                            if(item.difficultyCode === '02'){
                                lowArr.push(item);
                            }
                            if(item.difficultyCode === '03'){
                                middleArr.push(item);
                            }
                            if(item.difficultyCode === '04'){
                                highArr.push(item);
                            }
                        });
                        if(lowDiff<0){
                            lowArr.forEach(item =>{
                                itemArr.push(item.itemId);
                            });
                        } else {
                            for(let i=0 ; i<requestLow.data('count');i++){
                                itemArr.push(lowArr[i].itemId);
                            }
                        }
                        if(middleDiff<0){
                            middleArr.forEach(item =>{
                                itemArr.push(item.itemId);
                            });
                        } else {
                            for(let i=0 ; i<requestMiddle.data('count');i++){
                                itemArr.push(middleArr[i].itemId);
                            }
                        }
                        if(highDiff<0){
                            highArr.forEach(item=>{
                                itemArr.push(item.itemId);
                            });
                        } else {
                            for(let i=0 ; i<requestHigh.data('count');i++){
                                itemArr.push(highArr[i].itemId);
                            }
                        }
                        console.log("하 배열",lowArr);
                        console.log("중 배열",middleArr);
                        console.log("상 배열",highArr);

                        const difficulties = [
                            { name: 'low', diff: lowDiff, arr: lowArr, count: 0},
                            { name: 'middle', diff: middleDiff, arr: middleArr, count: 0},
                            { name: 'high', diff: highDiff, arr: highArr, count: 0}
                        ]

                        //부족분 채우기
                        while(minusTotal < 0) {
                            let flag = false;

                            for(let deficit of difficulties){
                                while(deficit.diff < 0){ // low, middle, high 중 부족한 경우
                                    let filled = false;
                                    for(let surplus of difficulties){
                                        if(surplus.diff > 0 && surplus.arr.length > 0){
                                            const item = surplus.arr.pop();
                                            if(item){
                                                itemArr.push(item.itemId);

                                                deficit.diff++; //해당 부족 부분 한 개 없어짐
                                                minusTotal++; // 총합도 한 개 없어짐
                                                surplus.count++;
                                                surplus.diff--; // 채워준 부분은 잉여부분이 한 개 없어짐

                                                filled = true;
                                                flag = true;
                                                break;
                                            }
                                        }
                                    }
                                    if(!filled){ // 못 채우면 그만
                                        break;
                                    }
                                }
                            }
                            if(!flag){ // 모두 채웠거나 잉여 문항이 없을 때
                                break;
                            }
                        }
                        console.log("minusTotal:", minusTotal);
                        console.log("lowDiff:", difficulties[0].diff);
                        console.log("middleDiff:", difficulties[1].diff);
                        console.log("highDiff:", difficulties[2].diff);
                        console.log("itemArr:", itemArr);
                        console.log("lowCount", difficulties[0].count);
                        console.log("MiddleCount", difficulties[1].count);
                        console.log("highCount", difficulties[2].count);
                        let finalLow = 0;
                        let finalMiddle = 0;
                        let finalHigh = 0;
                        if(difficulties[0].count === 0){
                            finalLow = Number(low); //실제로 온 값
                        } else {
                            finalLow = Number(requestLow.data('count') + difficulties[0].count);
                        }
                        if(difficulties[1].count === 0){
                            finalMiddle = Number(middle);
                        } else {
                            finalMiddle = Number(requestMiddle.data('count') + difficulties[1].count);
                        }
                        if(difficulties[2].count === 0){
                            finalHigh = Number(high);
                        } else {
                            finalHigh = Number(requestHigh.data('count') + difficulties[2].count);
                        }

                        console.log("finalLow:", finalLow);
                        console.log("finalMiddle:", finalMiddle);
                        console.log("finalHigh:", finalHigh);

                        let displayLow = $('#displayLow').text(finalLow);
                        let displayMiddle = $('#displayMiddle').text(finalMiddle);
                        let displayHigh = $('#displayHigh').text(finalHigh);
                        let displayTotal = $('#displayTotal').text(
                            ($('#displayLow').closest('div.range').hasClass('disappear') ? 0 : Number($('#displayLow').text())) +
                            ($('#displayMiddle').closest('div.range').hasClass('disappear') ? 0 : Number($('#displayMiddle').text())) +
                            ($('#displayHigh').closest('div.range').hasClass('disappear') ? 0 : Number($('#displayHigh').text()))
                        );

                        //확인 버튼
                        //step2넘어가기
                        $('#nextBtn2').on('click', function() {
                            let url = '/customExam/step2';
                            let new_form = $('<form></form>');
                            new_form.attr("name", "new_form");
                            new_form.attr("method", "post");
                            new_form.attr("action", url);
                            let strRequestBody = JSON.stringify(requestBody);
                            new_form.append($('<input/>', {type: 'hidden', name: 'questionIds', value: itemArr}));
                            new_form.append($('<input/>', {type: 'hidden', name: 'strRequestBody', value: strRequestBody}));
                            new_form.appendTo('body');
                            new_form.submit();
                        });
                    }


                }
            } catch(e){
                console.error('Error fetching data:', e);
            }
        }


    }
    $('#step0').on('click', function(){
        let url = 'http://localhost:8080/customExam/step0'; //수정해줘야 함
        let new_form = $('<form></form>');
        new_form.attr("name", "new_form");
        new_form.attr("charset", "UTF-8");
        new_form.attr("method", "post");
        new_form.attr("action", url);
        new_form.append($('<input/>', {type: 'hidden', name: 'subjectId', value: subjectId}));

        new_form.appendTo('body');
        new_form.submit();
    });



</script>
</body>
</html>